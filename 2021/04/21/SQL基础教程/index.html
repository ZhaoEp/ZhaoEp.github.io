<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="《SQL基础教程》"><meta name="keywords" content="读书笔记,sql"><meta name="author" content="ZEP"><meta name="copyright" content="ZEP"><title>《SQL基础教程》 | Data Castle</title><link rel="shortcut icon" href="/img/icon/site.png"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#第一章：数据库和SQL"><span class="toc-number">1.</span> <span class="toc-text">第一章：数据库和SQL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#表操作"><span class="toc-number">1.1.</span> <span class="toc-text">表操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建"><span class="toc-number">1.1.1.</span> <span class="toc-text">创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#命名规则"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">命名规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据类型"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">数据类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除"><span class="toc-number">1.1.2.</span> <span class="toc-text">删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更新"><span class="toc-number">1.1.3.</span> <span class="toc-text">更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#修改字段名"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">修改字段名</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#习题"><span class="toc-number">1.2.</span> <span class="toc-text">习题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第二章-查询基础"><span class="toc-number">2.</span> <span class="toc-text">第二章: 查询基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SELECT-语句基础"><span class="toc-number">2.1.</span> <span class="toc-text">SELECT 语句基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常数查询"><span class="toc-number">2.2.</span> <span class="toc-text">常数查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DISTINCT"><span class="toc-number">2.3.</span> <span class="toc-text">DISTINCT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WHERE"><span class="toc-number">2.4.</span> <span class="toc-text">WHERE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运算符"><span class="toc-number">2.5.</span> <span class="toc-text">运算符</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#算术运算符"><span class="toc-number">2.5.1.</span> <span class="toc-text">算术运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#比较运算符"><span class="toc-number">2.5.2.</span> <span class="toc-text">比较运算符</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#逻辑运算符"><span class="toc-number">2.6.</span> <span class="toc-text">逻辑运算符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#习题-1"><span class="toc-number">2.7.</span> <span class="toc-text">习题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第三章-聚合与排序"><span class="toc-number">3.</span> <span class="toc-text">第三章: 聚合与排序</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#聚合查询"><span class="toc-number">3.1.</span> <span class="toc-text">聚合查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分组"><span class="toc-number">3.2.</span> <span class="toc-text">分组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#排序"><span class="toc-number">3.3.</span> <span class="toc-text">排序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#习题-2"><span class="toc-number">3.4.</span> <span class="toc-text">习题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第四章-数据更新方法"><span class="toc-number">4.</span> <span class="toc-text">第四章: 数据更新方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据的插入"><span class="toc-number">4.1.</span> <span class="toc-text">数据的插入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#默认值"><span class="toc-number">4.1.1.</span> <span class="toc-text">默认值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从其他表种复制数据"><span class="toc-number">4.1.2.</span> <span class="toc-text">从其他表种复制数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#删除数据"><span class="toc-number">4.2.</span> <span class="toc-text">删除数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据更新"><span class="toc-number">4.3.</span> <span class="toc-text">数据更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事务"><span class="toc-number">4.4.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建事务"><span class="toc-number">4.4.1.</span> <span class="toc-text">创建事务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#习题-3"><span class="toc-number">4.5.</span> <span class="toc-text">习题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第五章-复杂查询"><span class="toc-number">5.</span> <span class="toc-text">第五章: 复杂查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#视图"><span class="toc-number">5.1.</span> <span class="toc-text">视图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建视图"><span class="toc-number">5.1.1.</span> <span class="toc-text">创建视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#视图的限制"><span class="toc-number">5.1.2.</span> <span class="toc-text">视图的限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除视图"><span class="toc-number">5.1.3.</span> <span class="toc-text">删除视图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#子查询"><span class="toc-number">5.2.</span> <span class="toc-text">子查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#标量子查询"><span class="toc-number">5.2.1.</span> <span class="toc-text">标量子查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关联子查询"><span class="toc-number">5.2.2.</span> <span class="toc-text">关联子查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#习题-4"><span class="toc-number">5.3.</span> <span class="toc-text">习题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第六章-函数，谓词，CASE表达式"><span class="toc-number">6.</span> <span class="toc-text">第六章: 函数，谓词，CASE表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#函数"><span class="toc-number">6.1.</span> <span class="toc-text">函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#算术函数"><span class="toc-number">6.1.1.</span> <span class="toc-text">算术函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#字符串函数"><span class="toc-number">6.1.2.</span> <span class="toc-text">字符串函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日期函数"><span class="toc-number">6.1.3.</span> <span class="toc-text">日期函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#转换函数"><span class="toc-number">6.1.4.</span> <span class="toc-text">转换函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#聚合函数：count，sum，avg，max，min-这五种"><span class="toc-number">6.1.5.</span> <span class="toc-text">聚合函数：count，sum，avg，max，min 这五种</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#谓词"><span class="toc-number">6.2.</span> <span class="toc-text">谓词</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#like"><span class="toc-number">6.2.1.</span> <span class="toc-text">like</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#between"><span class="toc-number">6.2.2.</span> <span class="toc-text">between</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#null、is-not-null"><span class="toc-number">6.2.3.</span> <span class="toc-text">null、is not null</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#in"><span class="toc-number">6.2.4.</span> <span class="toc-text">in</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exists"><span class="toc-number">6.2.5.</span> <span class="toc-text">exists</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#case表达式"><span class="toc-number">6.3.</span> <span class="toc-text">case表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简单case表达式"><span class="toc-number">6.3.1.</span> <span class="toc-text">简单case表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#搜索case表达式（包括简单case）"><span class="toc-number">6.3.2.</span> <span class="toc-text">搜索case表达式（包括简单case）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#习题-5"><span class="toc-number">6.4.</span> <span class="toc-text">习题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第七章-集合运算"><span class="toc-number">7.</span> <span class="toc-text">第七章: 集合运算</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#表（记录的集合）的加法-—-union"><span class="toc-number">7.1.</span> <span class="toc-text">表（记录的集合）的加法 — union</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#包含重复行的集合运算-—-all选项"><span class="toc-number">7.1.1.</span> <span class="toc-text">包含重复行的集合运算 — all选项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#选取表中公共部分-—-intersect"><span class="toc-number">7.2.</span> <span class="toc-text">选取表中公共部分 —  intersect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#记录的减法-—-except"><span class="toc-number">7.3.</span> <span class="toc-text">记录的减法 — except</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集合除法"><span class="toc-number">7.4.</span> <span class="toc-text">集合除法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#联结-join"><span class="toc-number">7.5.</span> <span class="toc-text">联结 join</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#习题-6"><span class="toc-number">7.6.</span> <span class="toc-text">习题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第八章-SQL高级处理"><span class="toc-number">8.</span> <span class="toc-text">第八章: SQL高级处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#窗口函数"><span class="toc-number">8.1.</span> <span class="toc-text">窗口函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#无partition"><span class="toc-number">8.1.1.</span> <span class="toc-text">无partition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#count-sum-min-max-avg"><span class="toc-number">8.1.2.</span> <span class="toc-text">count, sum, min, max, avg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#first-value与last-value"><span class="toc-number">8.1.3.</span> <span class="toc-text">first_value与last_value</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lead与lag"><span class="toc-number">8.1.4.</span> <span class="toc-text">lead与lag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rank、row-number、dense-rank"><span class="toc-number">8.1.5.</span> <span class="toc-text">rank、row_number、dense_rank</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ntile"><span class="toc-number">8.1.6.</span> <span class="toc-text">ntile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cume-dist、percent-rank"><span class="toc-number">8.1.7.</span> <span class="toc-text">cume_dist、percent_rank</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#grouping运算符"><span class="toc-number">8.2.</span> <span class="toc-text">grouping运算符</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rollup"><span class="toc-number">8.2.1.</span> <span class="toc-text">rollup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cube"><span class="toc-number">8.2.2.</span> <span class="toc-text">cube</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#grouping-sets"><span class="toc-number">8.2.3.</span> <span class="toc-text">grouping sets</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#习题-7"><span class="toc-number">8.3.</span> <span class="toc-text">习题</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/icon/t3.png"></div><div class="author-info__name text-center">ZEP</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/frog1024">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">3</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">4</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/top_background/jobs.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Data Castle</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/abouts">About</a></span></div><div id="post-info"><div id="post-title">《SQL基础教程》</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-21</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="第一章：数据库和SQL"><a href="#第一章：数据库和SQL" class="headerlink" title="第一章：数据库和SQL"></a>第一章：数据库和SQL</h1><h2 id="表操作"><a href="#表操作" class="headerlink" title="表操作"></a>表操作</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> sql_basic_tech;</span><br></pre></td></tr></table></figure>

<h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> product (</span><br><span class="line">    product_id <span class="built_in">char</span>(<span class="number">4</span>)  primary <span class="keyword">key</span>,</span><br><span class="line">    product_name <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    product_type <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    sale_price <span class="built_in">int</span>,</span><br><span class="line">    purchase_price <span class="built_in">int</span>,</span><br><span class="line">    regist_date <span class="built_in">date</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="命名规则"><a href="#命名规则" class="headerlink" title="命名规则"></a>命名规则</h4><p>字母，数字，下划线</p>
<p>名称必须以英文字母开头</p>
<h4 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h4><p>char, 存储定长字符串，空格填充</p>
<p>varchar, 变长字符串，不会填充</p>
<a id="more"></a>

<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> sql_basic_tech.product ;</span><br></pre></td></tr></table></figure>

<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sql_basic_tech.product  <span class="keyword">add</span> <span class="keyword">column</span> product_name_pinyin <span class="built_in">varchar</span>(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h4 id="修改字段名"><a href="#修改字段名" class="headerlink" title="修改字段名"></a>修改字段名</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sql_basic_tech.product <span class="keyword">change</span> puchase_price purchase_price <span class="built_in">int</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sql_basic_tech.product <span class="keyword">drop</span> <span class="keyword">column</span> product_name_pinyin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span>  * <span class="keyword">from</span> sql_basic_tech.product ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sql_basic_tech.product <span class="keyword">VALUES</span> (<span class="string">"0001"</span>, <span class="string">"T恤衫"</span>, <span class="string">"衣服"</span>, <span class="number">1000</span>, <span class="number">500</span>, <span class="string">"2009-09-20"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sql_basic_tech.product <span class="keyword">VALUES</span> (<span class="string">"0002"</span>, <span class="string">"打孔器"</span>, <span class="string">"办公用品"</span>,<span class="number">500</span>, <span class="number">320</span>, <span class="string">"2009-09-11"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sql_basic_tech.product <span class="keyword">VALUES</span> (<span class="string">"0003"</span>, <span class="string">"运动T恤"</span>, <span class="string">"衣服"</span>,<span class="number">4000</span>, <span class="number">2800</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sql_basic_tech.product <span class="keyword">VALUES</span> (<span class="string">"0004"</span>, <span class="string">"菜刀"</span>, <span class="string">"厨房用具"</span>,<span class="number">3000</span>, <span class="number">2800</span>, <span class="string">"2009-09-20"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sql_basic_tech.product <span class="keyword">VALUES</span> (<span class="string">"0005"</span>, <span class="string">"高压锅"</span>, <span class="string">"厨房用具"</span>,<span class="number">6800</span>, <span class="number">5000</span>, <span class="string">"2009-01-15"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sql_basic_tech.product <span class="keyword">VALUES</span> (<span class="string">"0006"</span>, <span class="string">"叉子"</span>, <span class="string">"厨房用具"</span>,<span class="number">500</span>, <span class="literal">NULL</span>, <span class="string">"2009-09-20"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sql_basic_tech.product <span class="keyword">VALUES</span> (<span class="string">"0007"</span>, <span class="string">"擦菜板"</span>, <span class="string">"厨房用具"</span>,<span class="number">880</span>, <span class="number">790</span>, <span class="string">"2008-04-28"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sql_basic_tech.product <span class="keyword">VALUES</span> (<span class="string">"0008"</span>, <span class="string">"圆珠笔"</span>, <span class="string">"办公用品"</span>,<span class="number">100</span>, <span class="literal">NULL</span>,<span class="string">"2009-11-11"</span>);</span><br></pre></td></tr></table></figure>

<h2 id="习题"><a href="#习题" class="headerlink" title="习题"></a>习题</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> p_addressbook_2(</span><br><span class="line">    regist_no <span class="built_in">int</span> primary <span class="keyword">key</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    address <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    tel_no <span class="built_in">char</span>(<span class="number">10</span>),</span><br><span class="line">    mail_address <span class="built_in">char</span>(<span class="number">20</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sql_basic_tech.p_addressbook_2 <span class="keyword">add</span> <span class="keyword">column</span> postal_code <span class="built_in">char</span>(<span class="number">8</span>) <span class="keyword">not</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> sql_basic_tech.p_addressbook_2;</span><br></pre></td></tr></table></figure>

<h1 id="第二章-查询基础"><a href="#第二章-查询基础" class="headerlink" title="第二章: 查询基础"></a>第二章: 查询基础</h1><h2 id="SELECT-语句基础"><a href="#SELECT-语句基础" class="headerlink" title="SELECT 语句基础"></a>SELECT 语句基础</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    product_id <span class="keyword">as</span> <span class="keyword">id</span>,</span><br><span class="line">    product_name <span class="keyword">as</span> <span class="keyword">name</span>,</span><br><span class="line">    purchase_price <span class="keyword">as</span> price</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    sql_basic_tech.product p;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    *</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p ;</span><br></pre></td></tr></table></figure>

<h2 id="常数查询"><a href="#常数查询" class="headerlink" title="常数查询"></a>常数查询</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="string">'商品'</span> <span class="keyword">as</span> <span class="keyword">string</span>,</span><br><span class="line">    <span class="number">38</span> <span class="keyword">as</span> <span class="built_in">number</span>,</span><br><span class="line">    <span class="string">'2009-02-24'</span> <span class="keyword">as</span> <span class="built_in">date</span>,</span><br><span class="line">    product_id ,</span><br><span class="line">    product_name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p ;</span><br></pre></td></tr></table></figure>

<h2 id="DISTINCT"><a href="#DISTINCT" class="headerlink" title="DISTINCT"></a>DISTINCT</h2><p>使用<code>distinct</code>时，<code>null</code>也被视为一类数据，只能用在第一个列名之前, 会作用之后的行, 不能写成<code>regist_date, distinct product_type</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="keyword">distinct</span> product_type , regist_date </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p ;</span><br></pre></td></tr></table></figure>

<h2 id="WHERE"><a href="#WHERE" class="headerlink" title="WHERE"></a>WHERE</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    product_type=<span class="string">'衣服'</span>;</span><br></pre></td></tr></table></figure>

<h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><h3 id="算术运算符"><a href="#算术运算符" class="headerlink" title="算术运算符"></a>算术运算符</h3><ul>
<li>所有包含NULL的计算，都为NULL</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    product_name ,</span><br><span class="line">    sale_price ,</span><br><span class="line">    sale_price * <span class="number">2</span> <span class="keyword">as</span> sale_price_x2</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    sql_basic_tech.product p ;</span><br></pre></td></tr></table></figure>

<h3 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h3><ul>
<li>日期可以直接进行比较</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_name ,</span><br><span class="line">    product_type ,</span><br><span class="line">    regist_date </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    sql_basic_tech.product p </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    regist_date  &lt; <span class="string">'2009-09-27'</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以使用计算表达式</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_name ,</span><br><span class="line">    sale_price ,</span><br><span class="line">    purchase_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    sale_price - purchase_price &gt;= <span class="number">500</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>不能对null使用比较运算符，使用is null判断</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_name ,</span><br><span class="line">    purchase_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    purchase_price <span class="keyword">is</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">--     purchase_price &lt;&gt; 2800;</span></span><br></pre></td></tr></table></figure>

<h2 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h2><ul>
<li>not</li>
<li>and</li>
<li>or</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_name ,</span><br><span class="line">    purchase_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    product_type = <span class="string">'厨房用具'</span> </span><br><span class="line">    <span class="keyword">or</span> purchase_price &gt;= <span class="number">3000</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_name ,</span><br><span class="line">    product_type ,</span><br><span class="line">    regist_date </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    product_type = <span class="string">'办公用品'</span></span><br><span class="line">    <span class="keyword">and</span> (regist_date = <span class="string">'2009-09-11'</span> </span><br><span class="line">    <span class="keyword">or</span> regist_date = <span class="string">'2009-09-20'</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>and的优先级大于or   </p>
</blockquote>
<h2 id="习题-1"><a href="#习题-1" class="headerlink" title="习题"></a>习题</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    *</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    product_name &gt; <span class="literal">null</span> ;</span><br><span class="line"><span class="comment">--     purchase_price &lt;&gt; null ;</span></span><br><span class="line"><span class="comment">--     purchase_price = null ;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_name ,</span><br><span class="line">    sale_price ,</span><br><span class="line">    purchase_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    sale_price - purchase_price &gt;= <span class="number">500</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_name ,</span><br><span class="line">    product_type ,</span><br><span class="line">    sale_price * <span class="number">0.9</span> - purchase_price <span class="keyword">as</span> profit</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    (product_type = <span class="string">'办公用品'</span> <span class="keyword">or</span> product_type = <span class="string">'厨房用具'</span>)</span><br><span class="line">    <span class="keyword">and</span> sale_price * <span class="number">0.9</span> - purchase_price &gt; <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<h1 id="第三章-聚合与排序"><a href="#第三章-聚合与排序" class="headerlink" title="第三章: 聚合与排序"></a>第三章: 聚合与排序</h1><h2 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h2><ul>
<li>count</li>
<li>sum</li>
<li>avg</li>
<li>max</li>
<li>min</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="keyword">count</span>(purchase_price)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p ;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>所有的聚合函数，如果以列名为参数，那么在计算之前就已经把NULL排除在外了。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="keyword">sum</span>(sale_price),</span><br><span class="line">    <span class="keyword">sum</span>(purchase_price)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sql_basic_tech.product p ;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>求平均值之前，也已经把NULL排除在外了</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="keyword">avg</span>(sale_price),</span><br><span class="line">    <span class="keyword">avg</span>(purchase_price) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p ;</span><br></pre></td></tr></table></figure>

<h2 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h2><p>注意：</p>
<ol>
<li>只能写在<code>select</code>子句之中</li>
<li><code>group by</code>子句不能使用select子句中的别名</li>
<li><code>group by</code>子句的聚合结果无序</li>
<li><code>where</code>子句中不能使用聚合函数</li>
</ol>
<blockquote>
<p>书写顺序：<code>select - from - where - group by - having - order by</code></p>
<p>执行顺序：<code>from - where - group by - having - select - order by</code></p>
</blockquote>
<p>聚合键中包含null时，结果中会以空行的形式表现出来</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    purchase_price ,</span><br><span class="line">    <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> purchase_price ;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    purchase_price ,</span><br><span class="line">    <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    product_type = <span class="string">'衣服'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    purchase_price ;</span><br></pre></td></tr></table></figure>

<p>与聚合函数和<code>group by</code>子句有关的常见错误</p>
<ol>
<li><p>在<code>select</code>中写了多余的列</p>
<p>使用聚合函数时，select子句中只能存在三种元素</p>
<ul>
<li><p>常数</p>
</li>
<li><p>聚合函数</p>
</li>
<li><p><code>group by</code>子句中指定的列名（聚合键）</p>
<blockquote>
<p>对于mysql下面能执行，在多列候补中只要有一列满足要求就可以了，其他DBMS不能执行</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&gt;select </span><br><span class="line">&gt; product_name ,</span><br><span class="line">&gt; purchase_price ,</span><br><span class="line">&gt; count(*)</span><br><span class="line">&gt;from </span><br><span class="line">&gt; product p </span><br><span class="line">&gt;group by purchase_price ;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
</li>
</ul>
</li>
<li><p>在<code>group by</code>子句中写了列的别名</p>
<blockquote>
<p>mysql和PostgreSQL能执行，但这并不是通常的使用方法</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&gt; select </span><br><span class="line">&gt;     product_type as pt,</span><br><span class="line">&gt;     count(*) </span><br><span class="line">&gt; from </span><br><span class="line">&gt;     product p2 </span><br><span class="line">&gt; group by pt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>在<code>where</code>子句中使用聚合函数</p>
<p>只有在<code>select</code>子句和<code>having</code>子句中可以使用聚合函数</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_type ,</span><br><span class="line">    <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    <span class="keyword">count</span>(*) = <span class="number">2</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    product_type ;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>为聚合结果指定条件</p>
<blockquote>
<p><code>where</code>只能指定行的条件，不能指定组的条件</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_type ,</span><br><span class="line">    <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    product_type</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">    <span class="keyword">count</span>(*) = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_type ,</span><br><span class="line">    <span class="keyword">avg</span>(sale_price) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    product_type</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">    <span class="keyword">avg</span>(sale_price) &gt;= <span class="number">2500</span>;</span><br></pre></td></tr></table></figure>

<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><p>查询结果进行排序，默认升序。对包含<code>null</code>的列进行排序，<code>null</code>会在结果的开头或末尾汇总显示</p>
<blockquote>
<p> mysql在开头显示</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&gt; select </span><br><span class="line">&gt;     product_id ,</span><br><span class="line">&gt;     product_name ,</span><br><span class="line">&gt;     sale_price ,</span><br><span class="line">&gt;     purchase_price </span><br><span class="line">&gt; from </span><br><span class="line">&gt;     product p </span><br><span class="line">&gt; order by purchase_price ;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><p>在<code>order by</code>中可以使用别名</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_id <span class="keyword">as</span> <span class="keyword">id</span>,</span><br><span class="line">    product_name ,</span><br><span class="line">    sale_price <span class="keyword">as</span> sp,</span><br><span class="line">    purchase_price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> sp ,<span class="keyword">id</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>order by</code>中可以使用存在于表中，但并不包含在<code>select</code>子句中的列</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    product_name ,</span><br><span class="line">    sale_price ,</span><br><span class="line">    purchase_price </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    product p </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> product_id ;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>order by</code>中可以使用聚合函数, 也可以使用<code>select</code>子句中未使用的聚合函数</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_type ,</span><br><span class="line">    <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p2 </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) ;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>order by</code>中可以使用列编号，<code>select</code>子句中的列按照从左到右，从1开始。但是不推荐使用</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_id ,</span><br><span class="line">    product_name ,</span><br><span class="line">    sale_price ,</span><br><span class="line">    purchase_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">    <span class="number">3</span> <span class="keyword">desc</span>, <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="习题-2"><a href="#习题-2" class="headerlink" title="习题"></a>习题</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_type ,</span><br><span class="line">    <span class="keyword">sum</span>(sale_price),</span><br><span class="line">    <span class="keyword">sum</span>(purchase_price) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    product_type </span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">    <span class="keyword">sum</span>(sale_price) &gt; <span class="keyword">sum</span>(purchase_price) * <span class="number">1.5</span> ;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    *</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">    regist_date <span class="keyword">desc</span> , sale_price;</span><br></pre></td></tr></table></figure>

<h1 id="第四章-数据更新方法"><a href="#第四章-数据更新方法" class="headerlink" title="第四章: 数据更新方法"></a>第四章: 数据更新方法</h1><h2 id="数据的插入"><a href="#数据的插入" class="headerlink" title="数据的插入"></a>数据的插入</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> sql_basic_tech.productIns (</span><br><span class="line">    product_id <span class="built_in">char</span>(<span class="number">4</span>)  primary <span class="keyword">key</span>,</span><br><span class="line">    product_name <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    product_type <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    sale_price <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">    purchase_price <span class="built_in">int</span>,</span><br><span class="line">    regist_date <span class="built_in">date</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> productins (product_id, product_name, product_type, sale_price, purchase_price, regist_date)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'0001'</span>, <span class="string">'T恤衫'</span>, <span class="string">'衣服'</span>, <span class="number">1000</span>, <span class="number">500</span>, <span class="string">'2009-09-20'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> sql_basic_tech.productins; </span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sql_basic_tech.productins <span class="keyword">values</span></span><br><span class="line">(<span class="string">"0002"</span>, <span class="string">"打孔器"</span>, <span class="string">"办公用品"</span>,<span class="number">500</span>, <span class="number">320</span>, <span class="string">"2009-09-11"</span>),</span><br><span class="line">(<span class="string">"0003"</span>, <span class="string">"运动T恤"</span>, <span class="string">"衣服"</span>,<span class="number">4000</span>, <span class="number">2800</span>, <span class="literal">NULL</span>),</span><br><span class="line">(<span class="string">"0004"</span>, <span class="string">"菜刀"</span>, <span class="string">"厨房用具"</span>,<span class="number">3000</span>, <span class="number">2800</span>, <span class="string">"2009-09-20"</span>),</span><br><span class="line">(<span class="string">"0005"</span>, <span class="string">"高压锅"</span>, <span class="string">"厨房用具"</span>,<span class="number">6800</span>, <span class="number">5000</span>, <span class="string">"2009-01-15"</span>),</span><br><span class="line">(<span class="string">"0006"</span>, <span class="string">"叉子"</span>, <span class="string">"厨房用具"</span>,<span class="number">500</span>, <span class="literal">NULL</span>, <span class="string">"2009-09-20"</span>),</span><br><span class="line">(<span class="string">"0007"</span>, <span class="string">"擦菜板"</span>, <span class="string">"厨房用具"</span>,<span class="number">880</span>, <span class="number">790</span>, <span class="string">"2008-04-28"</span>),</span><br><span class="line">(<span class="string">"0008"</span>, <span class="string">"圆珠笔"</span>, <span class="string">"办公用品"</span>,<span class="number">100</span>, <span class="literal">NULL</span>,<span class="string">"2009-11-11"</span>);</span><br></pre></td></tr></table></figure>

<h3 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> sql_basic_tech.productins <span class="keyword">values</span>(<span class="string">"0007"</span>, <span class="string">"擦菜板"</span>, <span class="string">"厨房用具"</span>,  <span class="keyword">default</span> ,<span class="number">790</span>, <span class="string">"2008-04-28"</span>);</span><br></pre></td></tr></table></figure>

<p>对省略字段直接使用默认值，建议使用<code>default</code>方式。如果省略了没有设置默认值的列，该列的值就会被设定为<code>null</code>。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> sql_basic_tech.productins <span class="keyword">values</span>(<span class="string">"0007"</span>, <span class="string">"擦菜板"</span>, <span class="string">"厨房用具"</span>,   , <span class="number">790</span>, <span class="string">"2008-04-28"</span>);</span><br></pre></td></tr></table></figure>

<h3 id="从其他表种复制数据"><a href="#从其他表种复制数据" class="headerlink" title="从其他表种复制数据"></a>从其他表种复制数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> sql_basic_tech.product_copy (</span><br><span class="line">    product_id <span class="built_in">char</span>(<span class="number">4</span>)  primary <span class="keyword">key</span>,</span><br><span class="line">    product_name <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    product_type <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    sale_price <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">    purchase_price <span class="built_in">int</span>,</span><br><span class="line">    regist_date <span class="built_in">date</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> product_copy</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product ;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> product_type(</span><br><span class="line">    product_type <span class="built_in">varchar</span>(<span class="number">32</span>) primary <span class="keyword">key</span>,</span><br><span class="line">    sum_sale_price <span class="built_in">int</span>,</span><br><span class="line">    sum_purchase_price <span class="built_in">int</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> product_type</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_type ,</span><br><span class="line">    <span class="keyword">sum</span>(sale_price),</span><br><span class="line">     <span class="keyword">sum</span>(purchase_price)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> product_type ;</span><br></pre></td></tr></table></figure>

<h2 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h2><p><code>delete</code>可以指定删除的条件，而<code>truncate</code>不能删除部分数据，但<code>truncate</code>速度更快</p>
<p><code>delete</code>子句中不能使用<code>group by</code>，<code>having</code>，<code>order by</code>三类子句</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">table</span> product_type</span><br><span class="line"><span class="keyword">where</span> sum_sale_price &gt; <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<h2 id="数据更新"><a href="#数据更新" class="headerlink" title="数据更新"></a>数据更新</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> product <span class="keyword">set</span> regist_date = <span class="string">'2009-10-10'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> product <span class="keyword">set</span> sale_price = sale_price * <span class="number">10</span></span><br><span class="line"><span class="keyword">where</span> product_type =<span class="string">'厨房用具'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> product <span class="keyword">set</span> sale_price = sale_price * <span class="number">10</span>, purchase_price = purchase_price  / <span class="number">2</span></span><br><span class="line"><span class="keyword">where</span> product_type =<span class="string">'厨房用具'</span>;</span><br></pre></td></tr></table></figure>

<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>需要在同一个处理单元中执行的一系列更新处理的集合</p>
<ul>
<li><code>A(atomictiy)</code>: 在事务结束时，其包含的更新，要不全执行，要不都不执行</li>
<li><code>C(consistency)</code>: 事务中包含的处理要满足数据库提前设置的约束</li>
<li><code>I(isolation)</code>: 不同事务之间互补干扰</li>
<li><code>D(durability)</code>: 事务结束后，保证数据状态会被保存</li>
</ul>
<h3 id="创建事务"><a href="#创建事务" class="headerlink" title="创建事务"></a>创建事务</h3><p><strong>每条SQL语句都是一个事务</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</span><br><span class="line">    <span class="keyword">update</span> product <span class="keyword">set</span> sale_price = sale_price - <span class="number">1000</span> <span class="keyword">where</span> product_name = <span class="string">"运动T恤"</span>;</span><br><span class="line">    <span class="keyword">update</span> product <span class="keyword">set</span> sale_price = sale_price + <span class="number">1000</span> <span class="keyword">where</span> product_name = <span class="string">"T恤衫"</span>;</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</span><br><span class="line">    <span class="keyword">update</span> product <span class="keyword">set</span> sale_price = sale_price - <span class="number">1000</span> <span class="keyword">where</span> product_name = <span class="string">"运动T恤"</span>;</span><br><span class="line">    <span class="keyword">update</span> product <span class="keyword">set</span> sale_price = sale_price + <span class="number">1000</span> <span class="keyword">where</span> product_name = <span class="string">"T恤衫"</span>;</span><br><span class="line"><span class="keyword">rollback</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> product p2 ;</span><br></pre></td></tr></table></figure>

<h2 id="习题-3"><a href="#习题-3" class="headerlink" title="习题"></a>习题</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> sql_basic_tech.product_p (</span><br><span class="line">    product_id <span class="built_in">char</span>(<span class="number">4</span>)  primary <span class="keyword">key</span>,</span><br><span class="line">    product_name <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    product_type <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    sale_price <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">    purchase_price <span class="built_in">int</span>,</span><br><span class="line">    regist_date <span class="built_in">date</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> product_p <span class="keyword">values</span>(<span class="string">"0001"</span>, <span class="string">"T恤衫"</span>, <span class="string">"衣服"</span>, <span class="number">1000</span>, <span class="number">500</span>, <span class="string">"2009-09-20"</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> product_p <span class="keyword">values</span>(<span class="string">"0002"</span>, <span class="string">"打孔器"</span>, <span class="string">"办公用品"</span>,<span class="number">500</span>, <span class="number">320</span>, <span class="string">"2009-09-11"</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> product_p <span class="keyword">values</span>(<span class="string">"0003"</span>, <span class="string">"运动T恤"</span>, <span class="string">"衣服"</span>,<span class="number">4000</span>, <span class="number">2800</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> sql_basic_tech.product_p;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> product_p <span class="keyword">select</span> * <span class="keyword">from</span> product_p ;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> sql_basic_tech.productMargin_p (</span><br><span class="line">    product_id <span class="built_in">char</span>(<span class="number">4</span>)  primary <span class="keyword">key</span>,</span><br><span class="line">    product_name <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    sale_price <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">    purchase_price <span class="built_in">int</span>,</span><br><span class="line">    margin <span class="built_in">int</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span>  productMargin_p;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> productMargin_p</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_id, </span><br><span class="line">    product_name, </span><br><span class="line">    sale_price, </span><br><span class="line">    purchase_price,</span><br><span class="line">    sale_price - purchase_price </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    product_p ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    *</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    productMargin_p;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- margin的sale_price是减过1000之后的，操作结果</span></span><br><span class="line"><span class="keyword">update</span> productMargin_p</span><br><span class="line"><span class="keyword">set</span> sale_price = sale_price - <span class="number">1000</span>, margin = sale_price - purchase_price</span><br><span class="line"><span class="keyword">where</span> product_name = <span class="string">'运动T恤'</span>;</span><br></pre></td></tr></table></figure>

<h1 id="第五章-复杂查询"><a href="#第五章-复杂查询" class="headerlink" title="第五章: 复杂查询"></a>第五章: 复杂查询</h1><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><ol>
<li>节省存储空间，不存储数据，就是保存好的SELECT语句</li>
<li>避免书写重复的<code>SELECT</code>语句</li>
</ol>
<h3 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> ProductSum(product_type, cnt_product)</span><br><span class="line"><span class="keyword">as</span> </span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    product_type ,</span><br><span class="line">    <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    product_type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    product_type ,</span><br><span class="line">    cnt_product </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    productsum p2 ;</span><br></pre></td></tr></table></figure>

<p>可以以视图创建视图, 应该尽量避免在视图上创建视图，这会降低SQL的性能</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> productsumJim(product_type ,cnt_product)</span><br><span class="line"><span class="keyword">as</span> </span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_type ,</span><br><span class="line">    cnt_product </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    productsum p </span><br><span class="line"><span class="keyword">where</span> product_type = <span class="string">'办公用品'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> productsumjim p ;</span><br></pre></td></tr></table></figure>

<h3 id="视图的限制"><a href="#视图的限制" class="headerlink" title="视图的限制"></a>视图的限制</h3><ol>
<li><p>定义视图时不能使用<code>order by</code>子句。因为，视图和表一样，数据行都是没有顺序的</p>
</li>
<li><p>对视图进行更新，视图原表派生出来的。<code>select</code>满足下面条件的话，视图才可以被更新：</p>
<ul>
<li><p><code>select子</code>句中未使用<code>distinct</code></p>
</li>
<li><p><code>from</code>子句中只有一张表</p>
</li>
<li><p>未使用<code>group by</code>子句</p>
</li>
<li><p>未使用<code>having</code>子句</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>视图和表需要同时进行更新，因此通过汇总得到的视图无法进行更新</p>
</blockquote>
<h3 id="删除视图"><a href="#删除视图" class="headerlink" title="删除视图"></a>删除视图</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">view</span> productsumJim;</span><br></pre></td></tr></table></figure>

<h2 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h2><p>就是将用来定义视图的<code>select</code>语句直接用于<code>from</code>子句中</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    product_type ,</span><br><span class="line">    cnt_product</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        product_type ,</span><br><span class="line">        <span class="keyword">count</span>(*) <span class="keyword">as</span> cnt_product</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        product p2 </span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> product_type </span><br><span class="line">) ProductSum;</span><br></pre></td></tr></table></figure>

<h3 id="标量子查询"><a href="#标量子查询" class="headerlink" title="标量子查询"></a>标量子查询</h3><p>返回单一值的子查询。能够使用常数或者列名地方，无论是<code>select</code>子句，<code>group by</code>子句，<code>having</code>子句还是<code>order by</code>子句，几乎所有的地方都可以使用，但是绝对不能返回多行结果。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    product_id ,</span><br><span class="line">    product_name ,</span><br><span class="line">    sale_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p2 </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    sale_price &gt; (</span><br><span class="line">        <span class="keyword">select</span> </span><br><span class="line">            <span class="keyword">avg</span>(sale_price)</span><br><span class="line">        <span class="keyword">from</span> product p </span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<h3 id="关联子查询"><a href="#关联子查询" class="headerlink" title="关联子查询"></a>关联子查询</h3><p>因为标量子查询不能返回多行，所以使用关联子查询</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_id ,</span><br><span class="line">    product_name ,</span><br><span class="line">    sale_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p2 </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    sale_price &gt; (</span><br><span class="line">        <span class="keyword">select</span> </span><br><span class="line">            <span class="keyword">avg</span>(sale_price)</span><br><span class="line">        <span class="keyword">from</span> </span><br><span class="line">            product p </span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            p2.product_type  = p.product_type <span class="comment"># 在同一商品种类中对商品的销售的单价和平均值进行比较</span></span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">            product_type </span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<h2 id="习题-4"><a href="#习题-4" class="headerlink" title="习题"></a>习题</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> practice5_1(product_name, sale_price, regist_date)</span><br><span class="line"><span class="keyword">as</span> </span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_name, sale_price , regist_date </span><br><span class="line"><span class="keyword">from</span> product p </span><br><span class="line"><span class="keyword">where</span> regist_date = <span class="string">"2009-09-20"</span> <span class="keyword">and</span> sale_price &gt;= <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> practice5_1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> practice5_1 <span class="keyword">values</span>(<span class="string">'刀子'</span>, <span class="number">300</span>, <span class="string">'2009-11-02'</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    product_id ,product_name ,product_type , sale_price ,</span><br><span class="line">    (<span class="keyword">select</span> <span class="keyword">avg</span>(sale_price) <span class="keyword">from</span> product p3) <span class="keyword">as</span> sale_price_all</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    product p2;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用<code>where</code>的时候，无法获取子查询中的结果，只能进行比较</p>
</blockquote>
<blockquote>
<p>只有在<code>from</code>中才能获取到结果</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    p.product_id ,</span><br><span class="line">    p.product_name ,</span><br><span class="line">    p.product_type ,</span><br><span class="line">    p.sale_price ,</span><br><span class="line">    p1.avg_sale_price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p ,</span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">        p2.product_type ,<span class="keyword">avg</span>(sale_price) <span class="keyword">as</span> avg_sale_price</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        product p2 </span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> p2.product_type ) p1</span><br><span class="line"><span class="keyword">where</span> p.product_type = p1.product_type;</span><br></pre></td></tr></table></figure>

<h1 id="第六章-函数，谓词，CASE表达式"><a href="#第六章-函数，谓词，CASE表达式" class="headerlink" title="第六章: 函数，谓词，CASE表达式"></a>第六章: 函数，谓词，CASE表达式</h1><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="算术函数"><a href="#算术函数" class="headerlink" title="算术函数"></a>算术函数</h3><h3 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h3><h3 id="日期函数"><a href="#日期函数" class="headerlink" title="日期函数"></a>日期函数</h3><h3 id="转换函数"><a href="#转换函数" class="headerlink" title="转换函数"></a>转换函数</h3><h3 id="聚合函数：count，sum，avg，max，min-这五种"><a href="#聚合函数：count，sum，avg，max，min-这五种" class="headerlink" title="聚合函数：count，sum，avg，max，min 这五种"></a>聚合函数：<code>count</code>，<code>sum</code>，<code>avg</code>，<code>max</code>，<code>min</code> 这五种</h3><h2 id="谓词"><a href="#谓词" class="headerlink" title="谓词"></a>谓词</h2><h3 id="like"><a href="#like" class="headerlink" title="like"></a><code>like</code></h3><h3 id="between"><a href="#between" class="headerlink" title="between"></a><code>between</code></h3><h3 id="null、is-not-null"><a href="#null、is-not-null" class="headerlink" title="null、is not null"></a><code>null</code>、<code>is not null</code></h3><h3 id="in"><a href="#in" class="headerlink" title="in"></a><code>in</code></h3><p><code>in</code> 和 子查询</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> shopProduct(</span><br><span class="line">    shop_id <span class="built_in">char</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    shop_name <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    product_id <span class="built_in">char</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    quantity <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (shop_id, product_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000A'</span>, <span class="string">'东京'</span>, <span class="string">'0001'</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000A'</span>, <span class="string">'东京'</span>, <span class="string">'0002'</span>, <span class="number">50</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000A'</span>, <span class="string">'东京'</span>, <span class="string">'0003'</span>, <span class="number">15</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000B'</span>, <span class="string">'名古屋'</span>, <span class="string">'0002'</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000B'</span>, <span class="string">'名古屋'</span>, <span class="string">'0003'</span>, <span class="number">120</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000B'</span>, <span class="string">'名古屋'</span>, <span class="string">'0004'</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000B'</span>, <span class="string">'名古屋'</span>, <span class="string">'0006'</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000B'</span>, <span class="string">'名古屋'</span>, <span class="string">'0007'</span>, <span class="number">40</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000C'</span>, <span class="string">'大阪'</span>, <span class="string">'0003'</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000C'</span>, <span class="string">'大阪'</span>, <span class="string">'0004'</span>, <span class="number">50</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000C'</span>, <span class="string">'大阪'</span>, <span class="string">'0006'</span>, <span class="number">90</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000C'</span>, <span class="string">'大阪'</span>, <span class="string">'0007'</span>, <span class="number">70</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ShopProduct (shop_id, shop_name, product_id, quantity) <span class="keyword">VALUES</span> (<span class="string">'000D'</span>, <span class="string">'福冈'</span>, <span class="string">'0001'</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> ShopProduct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     product_name ,</span><br><span class="line">     sale_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p2 </span><br><span class="line"><span class="keyword">where</span> product_id <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        product_id </span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        shopproduct s2 </span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        shop_id = <span class="string">'000C'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="exists"><a href="#exists" class="headerlink" title="exists"></a><code>exists</code></h3><p><code>exists</code> ：判断是否存在满足某种条件的记录，存在返回真，不存在返回假，通常使用关联子查询作为参数。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     product_name ,</span><br><span class="line">     sale_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p2 </span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        <span class="number">1</span> <span class="comment"># 所以与select无关，习惯将其写成select *</span></span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        shopproduct s2 </span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        shop_id = <span class="string">'000C'</span></span><br><span class="line">        <span class="keyword">and</span> p2.product_id  = s2.product_id </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     product_name ,</span><br><span class="line">     sale_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p2 </span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        <span class="number">1</span> <span class="comment"># 所以与select无关，习惯将其写成select *</span></span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        shopproduct s2 </span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        shop_id = <span class="string">'000A'</span></span><br><span class="line">        <span class="keyword">and</span> p2.product_id  = s2.product_id </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>exists</code>只会判断是否存在满足子查询中<code>WHERE</code>子句指定的条件”商店编号（shop_id）为 ‘000C’，商品（Product）表和商店商品（ShopProduct）表中商品编号（product_id）相同”的记录，只有存在这样的记录时才返回真（TRUE）。</p>
<h2 id="case表达式"><a href="#case表达式" class="headerlink" title="case表达式"></a>case表达式</h2><h3 id="简单case表达式"><a href="#简单case表达式" class="headerlink" title="简单case表达式"></a>简单case表达式</h3><h3 id="搜索case表达式（包括简单case）"><a href="#搜索case表达式（包括简单case）" class="headerlink" title="搜索case表达式（包括简单case）"></a>搜索case表达式（包括简单case）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    product_name ,</span><br><span class="line">    <span class="keyword">case</span></span><br><span class="line">        <span class="keyword">when</span> product_type = <span class="string">'衣服'</span> <span class="keyword">then</span> <span class="keyword">concat</span>(<span class="string">'A:'</span>, product_type)</span><br><span class="line">        <span class="keyword">when</span> product_type = <span class="string">'办公用品'</span> <span class="keyword">then</span> <span class="keyword">concat</span>(<span class="string">'B:'</span>, product_type)</span><br><span class="line">        <span class="keyword">when</span> product_type = <span class="string">'厨房用具'</span> <span class="keyword">then</span> <span class="keyword">concat</span>(<span class="string">'C:'</span>, product_type)</span><br><span class="line">        <span class="keyword">else</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">as</span> abc_product_type <span class="comment"># case中end不能省略</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    product p ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    product_type ,</span><br><span class="line">    <span class="keyword">sum</span>(sale_price) <span class="keyword">as</span> sum_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p2 </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> product_type ;</span><br></pre></td></tr></table></figure>

<p><strong>列 -&gt; 行</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- select </span></span><br><span class="line"><span class="comment">--     case</span></span><br><span class="line"><span class="comment">--         when product_type = '衣服' then sum(sale_price)</span></span><br><span class="line"><span class="comment">--     end as sum_price_clothes,</span></span><br><span class="line"><span class="comment">--     case</span></span><br><span class="line"><span class="comment">--         when product_type = '办公用品' then sum(sale_price)</span></span><br><span class="line"><span class="comment">--     end as sum_price_office,</span></span><br><span class="line"><span class="comment">--     case</span></span><br><span class="line"><span class="comment">--         when product_type = '厨房用具' then sum(sale_price)</span></span><br><span class="line"><span class="comment">--     end as sum_price_kitchen,</span></span><br><span class="line"><span class="comment">-- from </span></span><br><span class="line"><span class="comment">--     product p </span></span><br><span class="line"><span class="comment">-- group by</span></span><br><span class="line"><span class="comment">--     product_type ;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> product_type=<span class="string">'衣服'</span> <span class="keyword">then</span> sale_price <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> sum_price_clothes,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> product_type=<span class="string">'厨房用具'</span> <span class="keyword">then</span> sale_price <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> sum_price_kitchen,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> product_type=<span class="string">'办公用品'</span> <span class="keyword">then</span> sale_price <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> sum_price_office</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p ;</span><br></pre></td></tr></table></figure>

<h2 id="习题-5"><a href="#习题-5" class="headerlink" title="习题"></a>习题</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sale_price &lt; <span class="number">1000</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> low_price,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sale_price &gt;= <span class="number">1000</span> <span class="keyword">and</span> sale_price &lt; <span class="number">3000</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> mid_price,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sale_price &gt;= <span class="number">3000</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> high_price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    product p ;</span><br></pre></td></tr></table></figure>

<h1 id="第七章-集合运算"><a href="#第七章-集合运算" class="headerlink" title="第七章: 集合运算"></a>第七章: 集合运算</h1><h2 id="表（记录的集合）的加法-—-union"><a href="#表（记录的集合）的加法-—-union" class="headerlink" title="表（记录的集合）的加法 — union"></a>表（记录的集合）的加法 — <code>union</code></h2><p>通常会除去重复的记录</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Product2(</span><br><span class="line">	product_id <span class="built_in">CHAR</span>(<span class="number">4</span>) primary <span class="keyword">key</span>,</span><br><span class="line">	product_name <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	product_type <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	sale_price <span class="built_in">INTEGER</span> ,</span><br><span class="line">	purchase_price <span class="built_in">INTEGER</span> ,</span><br><span class="line">	regist_date <span class="built_in">DATE</span> </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Product2 <span class="keyword">VALUES</span> (<span class="string">'0001'</span>, <span class="string">'T恤衫'</span> ,<span class="string">'衣服'</span>, <span class="number">1000</span>, <span class="number">500</span>, <span class="string">'2008-09-20'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Product2 <span class="keyword">VALUES</span> (<span class="string">'0002'</span>, <span class="string">'打孔器'</span>, <span class="string">'办公用品'</span>, <span class="number">500</span>, <span class="number">320</span>, <span class="string">'2009-09-11'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Product2 <span class="keyword">VALUES</span> (<span class="string">'0003'</span>, <span class="string">'运动T恤'</span>, <span class="string">'衣服'</span>, <span class="number">4000</span>, <span class="number">2800</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Product2 <span class="keyword">VALUES</span> (<span class="string">'0009'</span>, <span class="string">'手套'</span>, <span class="string">'衣服'</span>, <span class="number">800</span>, <span class="number">500</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Product2 <span class="keyword">VALUES</span> (<span class="string">'0010'</span>, <span class="string">'水壶'</span>, <span class="string">'厨房用具'</span>, <span class="number">2000</span>, <span class="number">1700</span>, <span class="string">'2009-09-20'</span>);</span><br></pre></td></tr></table></figure>

<p>集合运算的注意事项</p>
<ol>
<li>作为运算对象的记录的列数必须相同</li>
<li>作为运算对象的记录中列的类型必须一致</li>
<li>可以使用任何<code>select</code>语句，但<code>order by</code>子句只能在最后使用一次</li>
</ol>
<h3 id="包含重复行的集合运算-—-all选项"><a href="#包含重复行的集合运算-—-all选项" class="headerlink" title="包含重复行的集合运算 — all选项"></a>包含重复行的集合运算 — <code>all</code>选项</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	product_id ,</span><br><span class="line">	product_name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 </span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	product_id ,</span><br><span class="line">	product_name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p3 ;</span><br></pre></td></tr></table></figure>

<h2 id="选取表中公共部分-—-intersect"><a href="#选取表中公共部分-—-intersect" class="headerlink" title="选取表中公共部分 —  intersect"></a>选取表中公共部分 —  <code>intersect</code></h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	product_id ,</span><br><span class="line">	product_name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 </span><br><span class="line"><span class="keyword">intersect</span> </span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	product_id ,</span><br><span class="line">	product_name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p ;</span><br></pre></td></tr></table></figure>

<h2 id="记录的减法-—-except"><a href="#记录的减法-—-except" class="headerlink" title="记录的减法 — except"></a>记录的减法 — <code>except</code></h2><p>结果与表的顺序有关</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	product_id ,</span><br><span class="line">	product_name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 </span><br><span class="line"><span class="keyword">except</span> </span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	product_id ,</span><br><span class="line">	product_name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p ;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>mysql 不支持 <code>except</code>，使用外连接替代except</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&gt; select </span><br><span class="line">&gt; 	p.product_id ,</span><br><span class="line">&gt; 	p.product_name </span><br><span class="line">&gt; from </span><br><span class="line">&gt; 	product p </span><br><span class="line">&gt; 	left outer join product2 p2 on p.product_id = p2.product_id </span><br><span class="line">&gt; where p2.product_id is null ;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="集合除法"><a href="#集合除法" class="headerlink" title="集合除法"></a>集合除法</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Skills(</span><br><span class="line">	skill <span class="built_in">VARCHAR</span>(<span class="number">32</span>) PRIMARY <span class="keyword">KEY</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> empskills(</span><br><span class="line">	emp <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">	skill <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">	primary <span class="keyword">key</span> (emp, skill)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Skills <span class="keyword">VALUES</span>(<span class="string">'Oracle'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Skills <span class="keyword">VALUES</span>(<span class="string">'UNIX'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Skills <span class="keyword">VALUES</span>(<span class="string">'Java'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'相田'</span>, <span class="string">'Oracle'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'相田'</span>, <span class="string">'UNIX'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'相田'</span>, <span class="string">'Java'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'相田'</span>, <span class="string">'C#'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'神崎'</span>, <span class="string">'Oracle'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'神崎'</span>, <span class="string">'UNIX'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'神崎'</span>, <span class="string">'Java'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'平井'</span>, <span class="string">'UNIX'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'平井'</span>, <span class="string">'Oracle'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'平井'</span>, <span class="string">'PHP'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'平井'</span>, <span class="string">'Perl'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'平井'</span>, <span class="string">'C++'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'若田部'</span>, <span class="string">'Perl'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EmpSkills <span class="keyword">VALUES</span>(<span class="string">'渡来'</span>, <span class="string">'Oracle'</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="keyword">distinct</span> emp</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	empskills e </span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">	<span class="keyword">select</span> s3.skill </span><br><span class="line">	<span class="keyword">from</span> skills s3</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> empskills e2 <span class="keyword">on</span> s3.skill = e2.skill </span><br><span class="line">	<span class="keyword">where</span> e.emp = e2.emp <span class="keyword">and</span> e2.skill <span class="keyword">is</span> <span class="literal">null</span> </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> e2.skill </span><br><span class="line"><span class="keyword">from</span> empskills e2</span><br><span class="line">     <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> skills s3 <span class="keyword">on</span> s3.skill = e2.skill </span><br><span class="line"><span class="keyword">where</span> s3.skill <span class="keyword">is</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">	* </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	empskills e2 <span class="keyword">cross</span> <span class="keyword">join</span> empskills e3 <span class="keyword">on</span> e2.emp = e3.emp ;</span><br></pre></td></tr></table></figure>

<h2 id="联结-join"><a href="#联结-join" class="headerlink" title="联结 join"></a>联结 join</h2><p>就是将其他表中的列添加过来，<code>union</code>是以行为单位进行操作，<code>join</code>则是以列为单位进行的。以a中的列作为桥梁，将b中满足同样条件的列汇集到同一结果之中。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">	shop_id,</span><br><span class="line">	shop_name,</span><br><span class="line">	p.product_id ,</span><br><span class="line">	product_name ,</span><br><span class="line">	sale_price</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">	product p</span><br><span class="line">	<span class="keyword">join</span> shopproduct s <span class="keyword">on</span> p.product_id = s.product_id</span><br><span class="line"><span class="keyword">where</span> <span class="comment"># 连接后的结果就是新创建的一张表</span></span><br><span class="line">	s.shop_id = <span class="string">'000A'</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sql_basic_tech.InventoryProduct ( </span><br><span class="line">	inventory_id <span class="built_in">CHAR</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	product_id <span class="built_in">CHAR</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	inventory_quantity <span class="built_in">INTEGER</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	primary <span class="keyword">key</span> (inventory_id, product_id)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P001'</span>, <span class="string">'0001'</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P001'</span>, <span class="string">'0002'</span>, <span class="number">120</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P001'</span>, <span class="string">'0003'</span>, <span class="number">200</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P001'</span>, <span class="string">'0004'</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P001'</span>, <span class="string">'0005'</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P001'</span>, <span class="string">'0006'</span>, <span class="number">99</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P001'</span>, <span class="string">'0007'</span>, <span class="number">999</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P001'</span>, <span class="string">'0008'</span>, <span class="number">200</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P002'</span>, <span class="string">'0001'</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P002'</span>, <span class="string">'0002'</span>, <span class="number">25</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P002'</span>, <span class="string">'0003'</span>, <span class="number">34</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P002'</span>, <span class="string">'0004'</span>, <span class="number">19</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P002'</span>, <span class="string">'0005'</span>, <span class="number">99</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P002'</span>, <span class="string">'0006'</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P002'</span>, <span class="string">'0007'</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> InventoryProduct (inventory_id, product_id, inventory_quantity) <span class="keyword">VALUES</span> (<span class="string">'P002'</span>, <span class="string">'0008'</span>, <span class="number">18</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> InventoryProduct;</span><br></pre></td></tr></table></figure>

<p>三张表联结</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">	shop_id,</span><br><span class="line">	shop_name,</span><br><span class="line">	p.product_id ,</span><br><span class="line">	product_name ,</span><br><span class="line">	sale_price</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">	product p</span><br><span class="line">	<span class="keyword">join</span> shopproduct s <span class="keyword">on</span> p.product_id = s.product_id</span><br><span class="line">	<span class="keyword">join</span> inventoryproduct i <span class="keyword">on</span> s.product_id = i.product_id </span><br><span class="line"><span class="keyword">where</span> i.inventory_id = <span class="string">'P001'</span>;</span><br></pre></td></tr></table></figure>

<h2 id="习题-6"><a href="#习题-6" class="headerlink" title="习题"></a>习题</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">when</span> shop_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> shop_id <span class="keyword">else</span> <span class="string">'不确定'</span> <span class="keyword">end</span> <span class="keyword">as</span> shop_id, </span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">when</span> shop_name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> shop_name <span class="keyword">else</span> <span class="string">'不确定'</span> <span class="keyword">end</span> <span class="keyword">as</span> shop_name,</span><br><span class="line">	p2.product_id ,</span><br><span class="line">	product_name ,</span><br><span class="line">	sale_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 </span><br><span class="line">	<span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> shopproduct s2 <span class="keyword">on</span> p2.product_id = s2.product_id ;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="keyword">coalesce</span>(shop_id, <span class="string">'不确定'</span>)  <span class="keyword">as</span> shop_id, </span><br><span class="line">	<span class="keyword">coalesce</span>(shop_name, <span class="string">'不确定'</span>)  <span class="keyword">as</span> shop_name,</span><br><span class="line">	p2.product_id ,</span><br><span class="line">	product_name ,</span><br><span class="line">	sale_price </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 </span><br><span class="line">	<span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> shopproduct s2 <span class="keyword">on</span> p2.product_id = s2.product_id ;</span><br></pre></td></tr></table></figure>

<h1 id="第八章-SQL高级处理"><a href="#第八章-SQL高级处理" class="headerlink" title="第八章: SQL高级处理"></a>第八章: SQL高级处理</h1><h2 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	product_name ,</span><br><span class="line">	product_type ,</span><br><span class="line">	sale_price ,</span><br><span class="line">	<span class="keyword">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> product_type <span class="keyword">order</span> <span class="keyword">by</span> sale_price) <span class="keyword">as</span> ranking</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">	product p;</span><br></pre></td></tr></table></figure>

<h3 id="无partition"><a href="#无partition" class="headerlink" title="无partition"></a>无partition</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	product_name ,</span><br><span class="line">	product_type ,</span><br><span class="line">	sale_price ,</span><br><span class="line">	<span class="keyword">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> sale_price) <span class="keyword">as</span> ranking <span class="comment"># 有相同的位次，会跳过之后的位次</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">	product p; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> order_detail(</span><br><span class="line">	user_id <span class="built_in">varchar</span>(<span class="number">50</span>) primary <span class="keyword">key</span>,</span><br><span class="line">	device_id <span class="built_in">varchar</span>(<span class="number">50</span>),</span><br><span class="line">	user_type <span class="built_in">char</span>(<span class="number">3</span>),</span><br><span class="line">	price <span class="keyword">double</span>,</span><br><span class="line">	sales <span class="built_in">int</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> order_detail <span class="keyword">values</span></span><br><span class="line">(<span class="string">'zhangsa'</span>, <span class="string">'dfsadsa323'</span>, <span class="string">'new'</span>, <span class="number">67.1</span>, <span class="number">2</span>),</span><br><span class="line">(<span class="string">'lisi'</span>, <span class="string">'543gfd'</span>, <span class="string">'old'</span>, <span class="number">43.32</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">'wanger'</span>, <span class="string">'65ghf'</span>, <span class="string">'new'</span>, <span class="number">88.88</span>, <span class="number">3</span>),</span><br><span class="line">(<span class="string">'liiu'</span>, <span class="string">'fdsfagwe'</span>, <span class="string">'new'</span>, <span class="number">66.0</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">'qibaqiu'</span>, <span class="string">'fds'</span>, <span class="string">'new'</span>, <span class="number">54.32</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">'wangshi'</span>, <span class="string">'d332'</span>, <span class="string">'old'</span>, <span class="number">77.77</span>, <span class="number">2</span>),</span><br><span class="line">(<span class="string">'liwei'</span>, <span class="string">'hfd'</span>, <span class="string">'old'</span>, <span class="number">88.44</span>, <span class="number">3</span>),</span><br><span class="line">(<span class="string">'wutong'</span>, <span class="string">'543gdfsd'</span>, <span class="string">'new'</span>, <span class="number">56.55</span>, <span class="number">6</span>),</span><br><span class="line">(<span class="string">'lilisi'</span>, <span class="string">'dsfgg'</span>, <span class="string">'new'</span>, <span class="number">88.88</span>, <span class="number">5</span>),</span><br><span class="line">(<span class="string">'qishili'</span>, <span class="string">'fds'</span>, <span class="string">'new'</span>, <span class="number">66.66</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<h3 id="count-sum-min-max-avg"><a href="#count-sum-min-max-avg" class="headerlink" title="count, sum, min, max, avg"></a>count, sum, min, max, avg</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">	user_id,</span><br><span class="line">	user_type ,</span><br><span class="line">	sales ,</span><br><span class="line">	<span class="comment">-- 默认从起点到当前行，如果出现了重复的数据，直接设置为和</span></span><br><span class="line">	<span class="keyword">sum</span>(sales) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">asc</span>) <span class="keyword">as</span> sales_1,</span><br><span class="line">	<span class="comment">-- 从起点到当前行</span></span><br><span class="line">	<span class="keyword">sum</span>(sales) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">asc</span> <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span>) <span class="keyword">as</span> sales_2,</span><br><span class="line">	<span class="comment">-- 当前行+往前3行</span></span><br><span class="line">	<span class="keyword">sum</span>(sales) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">asc</span> <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">3</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span>) <span class="keyword">as</span> sales_3,</span><br><span class="line">	<span class="comment">-- 当前行+往前3行+往后1行</span></span><br><span class="line">	<span class="keyword">sum</span>(sales) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">asc</span> <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">3</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">following</span>) <span class="keyword">as</span> sales_4,</span><br><span class="line">	<span class="comment">-- 当前行+往后所有行  </span></span><br><span class="line">	<span class="keyword">sum</span>(sales) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">asc</span> <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">current</span> <span class="keyword">row</span> <span class="keyword">and</span> <span class="keyword">unbounded</span> <span class="keyword">following</span>) <span class="keyword">as</span> sales_5,</span><br><span class="line">	<span class="comment">-- 分组内所有行</span></span><br><span class="line">	<span class="keyword">sum</span>(sales) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_type) <span class="keyword">as</span> sales_6,</span><br><span class="line">	<span class="comment">-- 以sales进行分组，排序</span></span><br><span class="line">	<span class="keyword">sum</span>(sales) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">asc</span>) <span class="keyword">as</span> sales_7</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	order_detail od </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">	user_type ,</span><br><span class="line">	sales ,</span><br><span class="line">	user_id ;</span><br></pre></td></tr></table></figure>

<p>注意:</p>
<p>​    结果和ORDER BY相关,默认为升序</p>
<p>​    如果不指定ROWS BETWEEN,默认为从起点到当前行;</p>
<p>​    如果不指定ORDER BY，则将分组内所有值累加; </p>
<p>​    缺少partition by</p>
<p>当ORDER BY后面缺少窗口从句条件，窗口规范默认是 RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW.</p>
<p>当ORDER BY和窗口从句都缺失, 窗口规范默认是 ROW BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING.</p>
<p>关键是理解ROWS BETWEEN含义,也叫做WINDOW子句：</p>
<ul>
<li>PRECEDING：往前</li>
<li>FOLLOWING：往后</li>
<li>CURRENT ROW：当前行</li>
<li>UNBOUNDED：无界限（起点或终点）</li>
<li>UNBOUNDED PRECEDING：表示从前面的起点 </li>
<li>UNBOUNDED FOLLOWING：表示到后面的终点</li>
</ul>
<p>其他COUNT、AVG，MIN，MAX，和SUM用法一样。</p>
<h3 id="first-value与last-value"><a href="#first-value与last-value" class="headerlink" title="first_value与last_value"></a>first_value与last_value</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    user_id,</span><br><span class="line">    user_type,</span><br><span class="line">    ROW_NUMBER() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> sales) <span class="keyword">AS</span> row_num,  </span><br><span class="line">    <span class="keyword">first_value</span>(user_id) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">desc</span>) <span class="keyword">as</span> max_sales_user,</span><br><span class="line">    <span class="keyword">first_value</span>(user_id) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">asc</span>) <span class="keyword">as</span> min_sales_user,</span><br><span class="line">    <span class="keyword">last_value</span>(user_id) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">desc</span>) <span class="keyword">as</span> curr_last_min_user,</span><br><span class="line">    <span class="keyword">last_value</span>(user_id) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">asc</span>) <span class="keyword">as</span> curr_last_max_user</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    order_detail;</span><br></pre></td></tr></table></figure>

<p>FIRST_VALUE: 取分组内排序后，截止到当前行，第一个值</p>
<p>LAST_VALUE: 取分组内排序后，截止到当前行，最后一个值</p>
<h3 id="lead与lag"><a href="#lead与lag" class="headerlink" title="lead与lag"></a>lead与lag</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    user_id,device_id,</span><br><span class="line">    <span class="keyword">lead</span>(device_id) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> sales) <span class="keyword">as</span> default_after_one_line,</span><br><span class="line">    lag(device_id) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> sales) <span class="keyword">as</span> default_before_one_line,</span><br><span class="line">    <span class="keyword">lead</span>(device_id,<span class="number">2</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> sales) <span class="keyword">as</span> after_two_line,</span><br><span class="line">    lag(device_id,<span class="number">2</span>,<span class="string">'abc'</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> sales) <span class="keyword">as</span> before_two_line</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    order_detail;</span><br></pre></td></tr></table></figure>

<p>LEAD(col,n,DEFAULT) ：用于统计窗口内往下第n行值。第一个参数为列名，第二个参数为往下第n行（可选，默认为1），第三个参数为默认值（当往下第n行为NULL时候，取默认值，如不指定，则为NULL）</p>
<p>LAG(col,n,DEFAULT) ：与lead相反，用于统计窗口内往上第n行值。第一个参数为列名，第二个参数为往上第n行（可选，默认为1），第三个参数为默认值（当往上第n行为NULL时候，取默认值，如不指定，则为NULL）</p>
<h3 id="rank、row-number、dense-rank"><a href="#rank、row-number、dense-rank" class="headerlink" title="rank、row_number、dense_rank"></a>rank、row_number、dense_rank</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    user_id,user_type,sales,</span><br><span class="line">    <span class="keyword">RANK</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">desc</span>) <span class="keyword">as</span> r,</span><br><span class="line">    ROW_NUMBER() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">desc</span>) <span class="keyword">as</span> rn,</span><br><span class="line">    <span class="keyword">DENSE_RANK</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_type <span class="keyword">order</span> <span class="keyword">by</span> sales <span class="keyword">desc</span>) <span class="keyword">as</span> dr</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    order_detail;</span><br></pre></td></tr></table></figure>

<p>ROW_NUMBER() 从1开始，按照顺序，生成分组内记录的序列,比如，按照pv降序排列，生成分组内每天的pv名次,ROW_NUMBER()的应用场景非常多，再比如，获取分组内排序第一的记录;获取一个session中的第一条refer等。</p>
<p>RANK() 生成数据项在分组中的排名，排名相等会在名次中留下空位</p>
<p>DENSE_RANK() 生成数据项在分组中的排名，排名相等会在名次中不会留下空位</p>
<h3 id="ntile"><a href="#ntile" class="headerlink" title="ntile"></a>ntile</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    user_type,sales,</span><br><span class="line">    <span class="comment">-- 分组内将数据分成2片</span></span><br><span class="line">    NTILE(<span class="number">2</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> sales) <span class="keyword">AS</span> nt2,</span><br><span class="line">    <span class="comment">-- 分组内将数据分成3片    </span></span><br><span class="line">    NTILE(<span class="number">3</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> sales) <span class="keyword">AS</span> nt3,</span><br><span class="line">    <span class="comment">-- 分组内将数据分成4片    </span></span><br><span class="line">    NTILE(<span class="number">4</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> sales) <span class="keyword">AS</span> nt4,</span><br><span class="line">    <span class="comment">-- 将所有数据分成4片</span></span><br><span class="line">    NTILE(<span class="number">4</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sales) <span class="keyword">AS</span> all_nt4</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    order_detail</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    user_type,</span><br><span class="line">    sales;</span><br></pre></td></tr></table></figure>

<p>NTILE(n) 用于将分组数据按照顺序切分成n片，返回当前切片值，如果切片不均匀，默认增加第一个切片的分布。</p>
<p>NTILE不支持ROWS BETWEEN，比如 NTILE(2) OVER(PARTITION BY cookieid ORDER BY createtime ROWS BETWEEN 3 PRECEDING AND CURRENT ROW)。</p>
<p>求取sale前20%的用户ID</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    user_id</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        user_id,</span><br><span class="line">        NTILE(<span class="number">5</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sales <span class="keyword">desc</span>) <span class="keyword">AS</span> nt</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        order_detail</span><br><span class="line">)A</span><br><span class="line"><span class="keyword">where</span> nt=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="cume-dist、percent-rank"><a href="#cume-dist、percent-rank" class="headerlink" title="cume_dist、percent_rank"></a>cume_dist、percent_rank</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	user_id,user_type,sales,</span><br><span class="line">	<span class="comment">-- 没有partition,所有数据均为1组</span></span><br><span class="line">	<span class="keyword">CUME_DIST</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sales) <span class="keyword">AS</span> cd1,</span><br><span class="line">	<span class="comment">-- 按照user_type进行分组</span></span><br><span class="line">	<span class="keyword">CUME_DIST</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> sales) <span class="keyword">AS</span> cd2 </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	order_detail; </span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	user_type,</span><br><span class="line">	sales,</span><br><span class="line">	<span class="comment">-- 分组内总行数      </span></span><br><span class="line">	<span class="keyword">SUM</span>(<span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_type) <span class="keyword">AS</span> s, </span><br><span class="line">	<span class="comment">-- RANK值  </span></span><br><span class="line">	<span class="keyword">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sales) <span class="keyword">AS</span> r,    </span><br><span class="line">	<span class="keyword">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sales) <span class="keyword">AS</span> pr,</span><br><span class="line">	<span class="comment">-- 分组内     </span></span><br><span class="line">	<span class="keyword">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> sales) <span class="keyword">AS</span> prg </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	order_detail;</span><br></pre></td></tr></table></figure>

<h2 id="grouping运算符"><a href="#grouping运算符" class="headerlink" title="grouping运算符"></a>grouping运算符</h2><p>合计行和小计同时得到</p>
<h3 id="rollup"><a href="#rollup" class="headerlink" title="rollup"></a>rollup</h3><p>将数据卷起来得到小计，然后再卷起来得到合计</p>
<p>组的个数：n+1</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	product_type ,</span><br><span class="line">	<span class="keyword">sum</span>(sale_price) <span class="keyword">as</span> sum_price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> product_type <span class="keyword">with</span> <span class="keyword">rollup</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	product_type ,</span><br><span class="line">	regist_date ,</span><br><span class="line">	<span class="keyword">sum</span>(sale_price) <span class="keyword">as</span> sum_price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> product_type , regist_date <span class="keyword">with</span> <span class="keyword">rollup</span> ;</span><br></pre></td></tr></table></figure>

<p>grouping函数, 能够简单地分辨出原始数据中的null和超级分组中的null</p>
<p>当超级分组记录（未使用group by的合计）为null时，返回1，否则返回0</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="keyword">grouping</span>(product_type) <span class="keyword">as</span> product_type,</span><br><span class="line">	<span class="keyword">grouping</span>(regist_date) <span class="keyword">as</span> regist_date ,</span><br><span class="line">	<span class="keyword">sum</span>(sale_price) <span class="keyword">as</span> sum_price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> product_type , regist_date <span class="keyword">with</span> <span class="keyword">rollup</span> ;</span><br></pre></td></tr></table></figure>

<p>插入恰当的字符串</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">grouping</span>(product_type) = <span class="number">1</span> <span class="keyword">then</span> <span class="string">'商品种类：合计'</span> <span class="keyword">else</span> product_type <span class="keyword">end</span>  <span class="keyword">as</span> product_type,</span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">grouping</span>(regist_date) = <span class="number">1</span> <span class="keyword">then</span> <span class="string">'登记日期：合计'</span> <span class="keyword">else</span> regist_date <span class="keyword">end</span> <span class="keyword">as</span> regist_date ,</span><br><span class="line">	<span class="keyword">sum</span>(sale_price) <span class="keyword">as</span> sum_price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> product_type , regist_date <span class="keyword">with</span> <span class="keyword">rollup</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> sum_price <span class="keyword">desc</span> ;</span><br></pre></td></tr></table></figure>

<h3 id="cube"><a href="#cube" class="headerlink" title="cube"></a>cube</h3><p>所谓cube就是将group by子句中聚合键的“所有可能的组合”的汇总结果集中到一个结果中</p>
<p>组合的个数就是2^n</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">grouping</span>(product_type) = <span class="number">1</span> <span class="keyword">then</span> <span class="string">'商品种类：合计'</span> <span class="keyword">else</span> product_type <span class="keyword">end</span>  <span class="keyword">as</span> product_type,</span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">grouping</span>(regist_date) = <span class="number">1</span> <span class="keyword">then</span> <span class="string">'登记日期：合计'</span> <span class="keyword">else</span> regist_date <span class="keyword">end</span> <span class="keyword">as</span> regist_date ,</span><br><span class="line">	<span class="keyword">sum</span>(sale_price) <span class="keyword">as</span> sum_price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">cube</span>(product_type , regist_date);</span><br></pre></td></tr></table></figure>

<h3 id="grouping-sets"><a href="#grouping-sets" class="headerlink" title="grouping sets"></a>grouping sets</h3><p>从rollup或者cube的结果中取出部分记录</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">grouping</span>(product_type) = <span class="number">1</span> <span class="keyword">then</span> <span class="string">'商品种类：合计'</span> <span class="keyword">else</span> product_type <span class="keyword">end</span>  <span class="keyword">as</span> product_type,</span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">grouping</span>(regist_date) = <span class="number">1</span> <span class="keyword">then</span> <span class="string">'登记日期：合计'</span> <span class="keyword">else</span> regist_date <span class="keyword">end</span> <span class="keyword">as</span> regist_date ,</span><br><span class="line">	<span class="keyword">sum</span>(sale_price) <span class="keyword">as</span> sum_price</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">grouping</span> <span class="keyword">sets</span> (product_type , regist_date);</span><br></pre></td></tr></table></figure>

<h2 id="习题-7"><a href="#习题-7" class="headerlink" title="习题"></a>习题</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	product_id ,</span><br><span class="line">	product_name ,</span><br><span class="line">	sale_price ,</span><br><span class="line">	<span class="keyword">max</span>(sale_price) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> product_id) <span class="keyword">as</span> current_max_price <span class="comment">-- 以product_id进行分组</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 将空行放置首位</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	product_id ,</span><br><span class="line">	product_name,</span><br><span class="line">	regist_date ,</span><br><span class="line">	<span class="keyword">sum</span>(sale_price) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">coalesce</span>(regist_date, <span class="keyword">cast</span>(<span class="string">'0001-01-01'</span> <span class="keyword">as</span> <span class="built_in">date</span>))) <span class="keyword">as</span> sale_am</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	product_id ,</span><br><span class="line">	product_name,</span><br><span class="line">	regist_date ,</span><br><span class="line">	<span class="keyword">sum</span>(sale_price) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> regist_date <span class="keyword">nulls</span> <span class="keyword">first</span>) <span class="keyword">as</span> sale_am</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	product p2 ;</span><br></pre></td></tr></table></figure>

</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">ZEP</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://frog1024.github.io/2021/04/21/SQL基础教程/">http://frog1024.github.io/2021/04/21/SQL基础教程/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/读书笔记/">读书笔记</a><a class="post-meta__tags" href="/tags/sql/">sql</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2019/06/02/hive编程指南/"><span>《Hive编程指南》</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/top_background/jobs.png)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2021 By ZEP</div><div class="footer_custom_text">Hi, Welcome to my <a href="https://frog1024.github.io">blog</a>!</div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>